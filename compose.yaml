services:
  headscale:
    image: headscale/headscale:latest
    restart: unless-stopped
    container_name: headscale
    ports:
      - "${HEADSCALE_EXTERNAL_PORT}:8080"
      - "127.0.0.1:9090:9090"
    environment:
      - TZ=${TZ}
    volumes:
      - ./headscale/config:/etc/headscale
      - ./headscale/lib/headscale:/var/lib/headscale
    command: serve
    depends_on:
      url-guard:
        condition: service_healthy

  headplane:
    image: ghcr.io/tale/headplane:latest
    container_name: headplane 
    restart: unless-stopped
    depends_on:
      url-guard:
        condition: service_healthy 
      headscale:
        condition: service_started
    ports:
      - '${HEADPLANE_EXTERNAL_PORT}:3000'
    volumes:
      - './headplane/config/config.yaml:/etc/headplane/config.yaml'
      - './headscale/config/config.yaml:/etc/headscale/config.yaml'
      - './headplane/data:/var/lib/headplane'
      - '/var/run/docker.sock:/var/run/docker.sock:ro'
    environment:
      - TZ=${TZ}

  url-guard:
    build: ./url-guard
    container_name: url-guard
    restart: unless-stopped
    environment:
      URL: "${URL}"
      INTERVAL_SECONDS: "${URL_INTERVAL:-10}"
      TIMEOUT_SECONDS: "${URL_TIMEOUT:-5}"
      MAX_REDIRS: "${URL_MAX_REDIRS:-10}"
      TARGET_CONTAINERS: "headscale headplane"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test: ["CMD", "/usr/local/bin/url-guard.sh", "check"]
      interval: 10s
      timeout: 6s
      retries: 5

networks:
  default:
